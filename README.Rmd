---
output: 
    github_document:
      pandoc_args: --webtex
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# vbar

<!-- badges: start -->
<!-- badges: end -->

The goal of `vbar` is to implement Variational Bayes Ancestral Reconstruction for collections of discrete and continuous phenotypic traits given a phylogeny of evolutionary relationships between species. Discrete traits may be ordinal or nominal, while continuous traits may be scalar- or function-valued. Ancestral Reconstruction is based on the Phylogenetic Latent Variable Model (PLVM) for trait evolution. This model accommodates repeated measurements for extant species.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("jpmeagher/vbar")
```

## Synthetic Example

Consider a synthetic example. Its analysis requires the following packages.

```{r packages, message = FALSE}
library(vbar)
library(ape)
library(ggplot2)
```

We will reconstruct $P = 4$ manifest traits for the common ancestors of $S = 128$ extant taxa, given $N_s = 3$  recordings of these traits for each extant species $s = 1, \dots S$ such that we have recordings for $N = 384$ individuals in total. These traits will consist of one ordinal, one nominal, one scalar-valued, and one function-valued trait. Our first task is to simulate these traits from the PLVM generative model.

### Phylogenetic Tree

The shared evolutionary history between taxa is modeled as a known, fixed phylogeny $\mathcal T = \left\{ \mathcal V, \mathcal B \right\}$. $\mathcal T$ is a bifurcating, directed, acyclic graph tree with nodes $\mathcal V = \left\{ v_1, \dots, v_{2S - 1} \right\}$ linked by branches $\mathcal B = \left\{ b_1, \dots, b_{2S - 2} \right\}$. The graph originates at the degree-2 root node $v_{2S - 1}$ and terminates at the degree-1 terminal nodes $v_1. \dots, v_{S}$ corresponding to the extant taxa. Node $v_s$ is linked to its parent $v_{\operatorname{pa} \left( s \right)}$ by the branch of length $b_s$ for all $s = 1, \dots, 2S - 2$. For notational convenience, we let $\boldsymbol t \in \mathcal T$ denote a continuous position along a branch of $\mathcal T$, where $\boldsymbol t_s$ corresponds to node $v_s$ for all $s = 1, \dots, 2S - 1$. Furthermore, we define the patristic distance operator $d_{\mathcal T} \left( \boldsymbol t, \boldsymbol t' \right)$, which is the the shortest path from $\boldsymbol t$ to $\boldsymbol t'$ over $\mathcal T$.

```{r set_phylogeny}
S <- 2^7
set.seed(98)
phy <- rcoal(S)
phy <- scale_phylo(phy, max_dist = 1)
```

```{r plot_phylogeny, echo = FALSE, fig.width=7, fig.height=4}
plot(
  phy,
  show.tip.label = FALSE, no.margin = FALSE
  )
axisPhylo(side = 1, root.time = 1, backward = TRUE)
title(
  main = "Synthetic Phylogeny",
  xlab = "Evolutionary Time"
)
```

### Phylogenetic Latent Variables

Given $\mathcal T$, we assume that the evolution of manifest traits is driven by $L = 3$ latent traits, modelled as independent Ornstein-Uhlenbeck (OU) processes on $\mathcal T$. These are the phylogenetic latent variables. For $\boldsymbol t \in \mathcal{T}$, we have
$$
\begin{aligned}
f_l \left( \boldsymbol t \right) &\sim \mathcal{GP} \left( 0, k_l \left( \boldsymbol t, \boldsymbol t' \right)\right), \\
k_l \left( \boldsymbol t, \boldsymbol t' \right) &=  h_l^2 \exp \left( - \frac{d_{\mathcal T} \left( \boldsymbol t, \boldsymbol t' \right) }{\ell} \right) + \left( 1 - h_l^2\right) \delta \left( \boldsymbol t \in \left\{ \boldsymbol t_1, \dots, \boldsymbol t_S\right\}\right)
\end{aligned}
$$
for $l = 1, \dots, L$, where $h_l^2 \in \left( 0, 1 \right)$ is the heritability of the $l^{th}$ latent trait, $\ell = 2$ is the fixed phylogenetic length-scale, and $\delta \left( \cdot \right)$ is the indicator function.

The OU process is a Gauss-Markov process, a property we will exploit to develop a computationally efficient inference scheme. If we denote $f_{s,l} = f_l \left( \boldsymbol t_s \right)$, then
$$
\begin{aligned}
f_{2S - 1, l} &\sim \mathcal N \left( 0, h^2 \right)\\
f_{s,l} \mid f_{\operatorname{pa} \left( s \right),l}, h &\sim \mathcal N \left( \nu_{s, l} f_{\operatorname{pa} \left( s \right),l}, \eta_{s, l}^2 \right)
\end{aligned}
$$
where, given $k_{s, s', l} = k_l \left( \boldsymbol t_s, \boldsymbol t_{s'} \right)$ and $k_{s, l} = k_l \left( \boldsymbol t_s, \boldsymbol t_{s} \right)$
$$
\begin{aligned}
\nu_{s, l} &= k_{s, \operatorname{pa} \left( s \right),l} k_{\operatorname{pa} \left( s \right), l}^{-1}, \\
&= \exp\left( -\frac{d_{\mathcal T} \left( \boldsymbol t_s, \boldsymbol t_{\operatorname{pa} \left( s \right)} \right) }{\ell}\right), \\
\eta_{s, l}^2 &= k_{s, l} - \nu_{s, l} \, k_{\operatorname{pa} \left( s \right), s, l}, \\
&= \frac{\ell h_l^2}{2} \left( 1 - \exp \left( - 2 \frac{d_{\mathcal T} \left( \boldsymbol t_s, \boldsymbol t_{\operatorname{pa} \left( s \right)} \right) }{\ell} \right) \right) + \left( 1 - h_l^2\right) \delta \left( \boldsymbol t \in \left\{ \boldsymbol t_1, \dots, \boldsymbol t_S\right\}\right).
\end{aligned}
$$
for $s = 1, \dots 2S - 1$ and $d_{\mathcal T} \left( \boldsymbol t_s, \boldsymbol t_{\operatorname{pa} \left( s \right)} \right) = b_s$.

In this example, we let $\boldsymbol h = \left( h_1, \dots, h_L \right)^\top = \left( \sqrt{0.95}, \sqrt{0.66}, \sqrt{0.25} \right)^\top$, such that the heritability of latent traits ranges from high to low.

```{r}
h <- sqrt(c(0.95, 0.66, 0.25))
latent_taxa_traits <- sapply(
  h, function(x) {
    simulate_phylogenetic_ou(
      phy = phy, 
      heritable_amplitude = x, length_scale = 2,
      environmental_amplitude = sqrt(1 - x^2),
      internal = TRUE
    )
  }
)
```


